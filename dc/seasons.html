<!DOCTYPE html>
<html>
<head>
    <title>DC Seasons</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.2/mapbox-gl-geocoder.min.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.4.0/mapbox-gl-compare.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.4.0/mapbox-gl-compare.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>
</head>
<body>
<style>
    body {
        overflow: hidden;
    }
     
    body * {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
     
    .map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
    }
</style>
<div id="comparison-container">
    <div id="before" class="map"></div>
    <div id="after" class="map"></div>
</div>
<script>
    mapboxgl.accessToken = "pk.eyJ1IjoieW9uaW5hY2htYW55bWFwYm94IiwiYSI6ImNrMTg3dXo4dDAwbHkzYnBob3dtajM4a2kifQ.SNPc6w7pfD_HalkSzRkFKw";
    const tilesetID = "yoninachmanymapbox.dc-ndsm";
    const tilesetRegex = new RegExp(`${tilesetID}/[0-9]+\/[0-9]+\/[0-9]+`);
    let beforeStyle = {
      version: 8,
      sources: {
        ortho2019: {
          type: "raster",
          tiles: ['https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Ortho2019_WebMercator/MapServer/tile/{z}/{y}/{x}'],
          tileSize: 256,
          attribution: '<a href="https://opendata.dc.gov/pages/dc-from-above">DCGIS Open Data</a>'
        }
      },
      layers: [
        {
          id: "ortho2019",
          type: "raster",
          source: "ortho2019",
        }
      ]
    };
    const beforeMap = new mapboxgl.Map({
        container: "before",
        style: beforeStyle,
        center: [-77.0146, 38.8938],
        zoom: 10.84,
        hash: true,
        transformRequest: (url, type) => {
          if (type === "Tile" && tilesetRegex.test(url) && !tilesetID.startsWith("mapbox")) {
            return { url: url.replace("webp", "pngraw") };
          }
        }
    });
    beforeMap.on("load", function() {
      beforeMap.addSource('nDSM', {
        'type': 'raster-dem',
        'url': `mapbox://${tilesetID}`,
        'tileSize': 512,
        'maxzoom': 14
      });

      beforeMap.setTerrain({ 'source': 'nDSM', 'exaggeration': 1 });
    });
    let afterStyle = {
      version: 8,
      sources: {
        ortho2021: {
          type: "raster",
          tiles: ['https://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Ortho2021_WebMercator/MapServer/tile/{z}/{y}/{x}'],
          tileSize: 256,
          attribution: '<a href="https://opendata.dc.gov/pages/dc-from-above">DCGIS Open Data</a>'
        }
      },
      layers: [
        {
          id: "ortho2021",
          type: "raster",
          source: "ortho2021",
        }
      ]
    };
    const afterMap = new mapboxgl.Map({
        container: "after",
        style: afterStyle,
        center: [-77.0146, 38.8938],
        zoom: 10.84,
        hash: true,
        transformRequest: (url, type) => {
          if (type === "Tile" && tilesetRegex.test(url) && !tilesetID.startsWith("mapbox")) {
            return { url: url.replace("webp", "pngraw") };
          }
        }
    });
    afterMap.on("load", function() {
      afterMap.addSource('nDSM', {
        'type': 'raster-dem',
        'url': `mapbox://${tilesetID}`,
        'tileSize': 512,
        'maxzoom': 14
      });

      afterMap.setTerrain({ 'source': 'nDSM', 'exaggeration': 1 });

      afterMap.addControl(
        new MapboxGeocoder({
          accessToken: mapboxgl.accessToken,
          mapboxgl: mapboxgl,
          marker: false,
          collapsed: true
        })
      );
    });
    const container = '#comparison-container';
    const map = new mapboxgl.Compare(beforeMap, afterMap, container, {});

</script>

</body>
</html>